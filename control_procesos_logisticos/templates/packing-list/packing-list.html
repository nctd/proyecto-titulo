{% extends 'base.html' %}

{% block content %}
<div class="container-xl">
    <!-- Page title -->
    <div class="page-header d-print-none">
        <div class="row align-items-center">
            <div class="col">
                <h2 class="page-title">
                    Packing List
                </h2>
            </div>
        </div>
    </div>
</div>
<div class="page-body">
    <div class="container-xl">
        <!-- Content here -->
        <div class="row row-cards">

            <div class="col-12">
                <div class="card">
                    <div class='card-header'>
                        <h3 class="card-title">Datos bulto</h3>
                    </div>
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label class="form-label">Orden de venta</label>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">
                                                OV
                                            </span>

                                            <input type="text" class="form-control" name="bulto_ov" id="bulto_ov">
                                        </div>


                                    </div>
                                </div>

                                <div class="col-xl-4 mb-3" id="container-agregar-ov">
                                    <label class="form-label" style="visibility: hidden;">bt</label>
                                    <button class="btn btn-primary w-100" id='btn-agregar-ov' type="button">
                                        <!-- Download SVG icon from http://tabler-icons.io/i/search -->
                                        <svg xmlns="http://www.w3.org/2000/svg" id="icon-agregar-ov"
                                            class="icon icon-tabler icon-tabler-plus" width="24" height="24"
                                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Ingresar OV
                                    </button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label class="form-label">Tipo de bulto</label>
                                        <!-- <input type="text" class="form-control" name="bulto_input" id="bulto_input"> -->
                                        {{form_detalle.tipo_bulto}}
                                    </div>
                                </div>
                                <div class="col-lg-1">
                                    <div class="mb-3">
                                        <label class="form-label">Largo (mt)</label>
                                        {{form_detalle.largo}}
                                    </div>
                                </div>
                                <div class="col-lg-1">
                                    <div class="mb-3">
                                        <label class="form-label">Ancho (mt)</label>
                                        {{form_detalle.ancho}}
                                    </div>
                                </div>
                                <div class="col-lg-2">
                                    <div class="mb-3">
                                        <label class="form-label">Volumen (mt)</label>
                                        {{form_detalle.volumen}}
                                    </div>
                                </div>
                                <div class="col-lg-2">
                                    <div class="mb-3">
                                        <label class="form-label">Peso bruto (kg)</label>
                                        {{form_detalle.peso_bruto}}
                                    </div>
                                </div>
                                <div class="col-lg-2">
                                    <div class="mb-3">
                                        <label class="form-label">Peso neto (kg)</label>
                                        {{form_detalle.peso_neto}}
                                    </div>
                                </div>

                            </div>

                            <!-- </div> -->
                        </div>
                        <div class="card-header">
                            <h3 class="card-title">Contenido bulto</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-1">
                                    <div class="mb-3">
                                        <label class="form-label">Línea</label>
                                        <input type="text" class="form-control" name="bulto_linea" id="bulto_linea">
                                    </div>
                                </div>

                                <div class="col-lg-2">
                                    <div class="mb-3">
                                        <label class="form-label">Código</label>
                                        <input type="text" class="form-control" name="bulto_codigo" id="bulto_codigo"
                                            style="background-color: #f1f5f9 !important" disabled>
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label class="form-label">Descripción</label>
                                        <input type="text" class="form-control" name="bulto_descripcion"
                                            id="bulto_descripcion" disabled>
                                    </div>
                                </div>

                                <div class="col-lg-1">
                                    <div class="mb-3">
                                        <label class="form-label">Cantidad</label>
                                        <input type="text" class="form-control" name="bulto_cantidad"
                                            id="bulto_cantidad">
                                    </div>
                                </div>

                                <div class="col-xl-4 mb-3">
                                    <label class="form-label" style="visibility: hidden;">bt</label>
                                    <button class="btn btn-primary w-100" id='btn-agregar-linea' type="button">
                                        <!-- Download SVG icon from http://tabler-icons.io/i/search -->
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            class="icon icon-tabler icon-tabler-plus" width="24" height="24"
                                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        Agregar línea
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <div class="gridjs gridjs-container">
                                    <table class="gridjs-table" id='tabla-bulto'>
                                        <thead class="gridjs-thead">
                                            <tr class="gridjs-tr">
                                                <th class="gridjs-th gridjs-th-sort gridjs-th-fixed text-center"
                                                    style="width: 50px;">
                                                    LÍNEA</th>
                                                <th class=" gridjs-th gridjs-th-sort gridjs-th-fixed text-center"
                                                    style="width: 150px;">
                                                    CÓDIGO
                                                </th>
                                                <th class=" gridjs-th gridjs-th-sort gridjs-th-fixed text-center"
                                                    style="width: 355px;">
                                                    DESCRIPCIÓN
                                                </th>
                                                <th class=" gridjs-th gridjs-th-sort gridjs-th-fixed text-center"
                                                    style="width: 50px;">
                                                    CANTIDAD
                                                </th>
                                                <th class=" gridjs-th gridjs-th-sort gridjs-th-fixed text-center"
                                                    style="width: 100px;">
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody class=" gridjs-tbody" style="text-align: center;">

                                        </tbody>
                                    </table>
                                </div>

                            </div>

                            <div class="row">
                                <div class="col-xl-3 mb-3">
                                    <button class="btn btn-primary w-100" type="button">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            class="icon icon-tabler icon-tabler-list-check" width="24" height="24"
                                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <path d="M3.5 5.5l1.5 1.5l2.5 -2.5"></path>
                                            <path d="M3.5 11.5l1.5 1.5l2.5 -2.5"></path>
                                            <path d="M3.5 17.5l1.5 1.5l2.5 -2.5"></path>
                                            <line x1="11" y1="6" x2="20" y2="6"></line>
                                            <line x1="11" y1="12" x2="20" y2="12"></line>
                                            <line x1="11" y1="18" x2="20" y2="18"></line>
                                        </svg>
                                        Finalizar bulto
                                    </button>
                                </div>
                                <div class="col-xl-3 mb-3">
                                    <button class="btn btn-primary w-100" type="button">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                            class="icon icon-tabler icon-tabler-layout-grid-add" width="24" height="24"
                                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                            <rect x="4" y="4" width="6" height="6" rx="1"></rect>
                                            <rect x="14" y="4" width="6" height="6" rx="1"></rect>
                                            <rect x="4" y="14" width="6" height="6" rx="1"></rect>
                                            <path d="M14 17h6m-3 -3v6"></path>
                                        </svg>
                                        Agregar bulto
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card-footer text-end">
                            <div class="d-flex">
                                <button type="submit" class="btn btn-success ms-auto" id="btn-guardar-pl">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        class="icon icon-tabler icon-tabler-file-plus" width="24" height="24"
                                        viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                        <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                                        <path
                                            d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z">
                                        </path>
                                        <line x1="12" y1="11" x2="12" y2="17"></line>
                                        <line x1="9" y1="14" x2="15" y2="14"></line>
                                    </svg>
                                    Guardar Packing-List y generar PDF
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal modal-blur fade" id="modal-existe-linea" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-status bg-danger"></div>
            <div class="modal-body text-center py-4">

                <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-danger icon-lg" width="24" height="24"
                    viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M12 9v2m0 4v.01" />
                    <path
                        d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75" />
                </svg>
                <h3>Alerta</h3>
                <div class="text-muted" id='content-existe-linea'> La línea ingresada ya se encuentra en el bulto
                </div>
            </div>
            <div class="modal-footer">
                <div class="w-100">
                    <div class="row">

                        <div class="col"><a href="#" class="btn btn-danger w-100" data-bs-dismiss="modal">
                                OK
                            </a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal modal-blur fade" id="modal-ov-valida" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-status bg-info"></div>
            <div class="modal-body text-center py-4">

                <!-- Download SVG icon from http://tabler-icons.io/i/file-check -->
                <svg xmlns="http://www.w3.org/2000/svg" class="icon mb-2 text-info icon-lg" width="24" height="24"
                    viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                    <path d="M14 3v4a1 1 0 0 0 1 1h4" />
                    <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" />
                    <path d="M9 15l2 2l4 -4" />
                </svg>

                <h3>Ingreso exitoso</h3>
                <div class="text-muted">Orden de venta valida</div>
            </div>
            <div class="modal-footer">
                <div class="w-100">
                    <div class="row">

                        <div class="col"><a href="#" class="btn btn-info w-100" data-bs-dismiss="modal">
                                OK
                            </a></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    const e = document.getElementById('nav-item-packing')
    e.classList.add('active')

</script>

<script>
    $("#btn-agregar-ov").on('click', function (e) {
        if ($('#bulto_ov').val() != '') {
            var ov = 'OV' + document.getElementById('bulto_ov').value
            $.ajax({
                type: 'GET',
                url: "{% url 'validar_orden_pl' %}",
                data: {
                    'orden_venta': ov,
                },
                dataType: "json",
                beforeSend: function () {
                    alert('ANTES DE ENVIAR')
                },
                success: function (response) {
                    document.getElementById('bulto_ov').disabled = true;
                    $('#modal-ov-valida').modal('show')
                    alert('VALIDO')
                }
            })
        } else {
            $('#bulto_ov').addClass('is-invalid');
            e.preventDefault()
        }
    })
</script>
<script>
    $("#bulto_linea").on('change', function (e) {
        alert('a')
        var ov = 'OV' + document.getElementById('bulto_ov').value
        var linea = document.getElementById('bulto_linea').value
        $.ajax({
            type: 'GET',
            url: "{% url 'obtener_articulo_pl' %}",
            data: {
                'orden_venta': ov,
                'linea': linea
            },
            dataType: "json",
            success: function (response) {
                alert(response)
                document.getElementById('bulto_codigo').value = response['codigo'];
                document.getElementById('bulto_descripcion').value = response['descripcion'];
            }
        })
    })
</script>
<script>
    var lista_lineas = []

    function eliminarFila(linea) {
        if (lista_lineas.includes(linea)) {
            var index = lista_lineas.indexOf(linea);
            if (index !== -1) {
                lista_lineas.splice(index, 1);
            }
        }
        var td = event.target.parentNode;
        var tr = td.parentNode;
        tr.parentNode.removeChild(tr);
    }

    $("#btn-agregar-linea").on('click', function (e) {
        if ($('#bulto_linea').val() == '' || $('#bulto_codigo').val() == '' || $('#bulto_descripcion').val() == '' || $('#bulto_cantidad').val() == '') {
            alert('SIN DATOS')
            if ($('#bulto_linea').val() == '') {
                $('#bulto_linea').addClass('is-invalid');
            }
            // if ($('#bulto_codigo').val() == '') {
            //     $('#bulto_codigo').addClass('is-invalid');
            // }
            // if ($('#bulto_descripcion').val() == '') {
            //     $('#bulto_descripcion').addClass('is-invalid');
            // }
            if ($('#bulto_cantidad').val() == '') {
                $('#bulto_cantidad').addClass('is-invalid');
            }
        } else {
            var linea = document.getElementById('bulto_linea').value
            var codigo = document.getElementById('bulto_codigo').value
            var descripcion = document.getElementById('bulto_descripcion').value
            var cantidad = document.getElementById('bulto_cantidad').value

            if (lista_lineas.includes(linea)) {
                $("#modal-existe-linea").modal('show');
            } else {
                lista_lineas.push(linea)
                $("#tabla-bulto").append(`<tr class="gridjs-tr">
                        <td class="gridjs-td">${linea}</td>
                        <td class="gridjs-td">${codigo}</td>
                        <td class="gridjs-td">${descripcion}</td>
                        <td class="gridjs-td">${cantidad}</td>
                        <td class="gridjs-td">
                            <a class="btn btn-danger" onclick="eliminarFila('${linea}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <line x1="4" y1="7" x2="20" y2="7"></line>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                            <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path>
                            <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path>
                            </svg>
                            Borrar
                            </a>
                        </td>
                        </tr>`);
                document.getElementById('bulto_linea').value = ""
                document.getElementById('bulto_codigo').value = ""
                document.getElementById('bulto_descripcion').value = ""
                document.getElementById('bulto_cantidad').value = ""
            }

        }
    })
</script>
<script>
    $("#bulto_linea").on('click', function (e) {
        event.stopPropagation();
        $('#bulto_linea').removeClass("is-invalid");
    })
    $("#bulto_cantidad").on('click', function (e) {
        event.stopPropagation();
        $('#bulto_cantidad').removeClass("is-invalid");
    })
</script>
<script>

</script>
{% endblock %}